<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Viewer & Editor</title>

    <!-- Styles -->
    <link rel="stylesheet" href="/styles/base.css">
    <link rel="stylesheet" href="/styles/layout.css">
    <link rel="stylesheet" href="/styles/components/toolbar.css">
    <link rel="stylesheet" href="/styles/components/sidebar.css">
    <link rel="stylesheet" href="/styles/components/editor.css">
    <link rel="stylesheet" href="/styles/components/preview.css">
    <link rel="stylesheet" href="/styles/components/dialog.css">

    <!-- External Libraries -->
    <!-- marked.js - GitHub Flavored Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.0/marked.min.js"></script>

    <!-- js-tiktoken - GPT tokenizer for token counting -->
    <script src="https://cdn.jsdelivr.net/npm/js-tiktoken@1.0.7/dist/tiktoken.js"></script>

    <!-- CodeMirror 6 - For future implementation -->
    <!-- Note: CodeMirror 6 is complex to load via CDN, using textarea fallback initially -->

    <!-- Scripts -->
    <script type="module" src="/scripts/main.js"></script>
</head>
<body>
    <!-- Main Container -->
    <div class="app-container">

        <!-- Top Toolbar -->
        <header class="toolbar">
            <div class="toolbar__section toolbar__section--left">
                <button class="toolbar__button" id="btn-new" title="New Document">
                    <span class="icon">&#43;</span>
                    <span class="label">New</span>
                </button>
                <button class="toolbar__button" id="btn-open" title="Open File">
                    <span class="icon">&#128193;</span>
                    <span class="label">Open</span>
                </button>
                <button class="toolbar__button" id="btn-save" title="Save">
                    <span class="icon">&#128190;</span>
                    <span class="label">Save</span>
                </button>

                <div class="toolbar__divider"></div>

                <button class="toolbar__button" id="btn-export" title="Export">
                    <span class="icon">&#8595;</span>
                    <span class="label">Export</span>
                </button>

                <button class="toolbar__button" id="btn-import" title="Import">
                    <span class="icon">&#8593;</span>
                    <span class="label">Import</span>
                </button>
            </div>

            <div class="toolbar__section toolbar__section--center">
                <h1 class="toolbar__title" id="document-title">Untitled Document</h1>
                <div class="toolbar__source" id="document-source" style="display: none;">
                    <span class="source-label"></span>
                </div>
            </div>

            <div class="toolbar__section toolbar__section--right">
                <button class="toolbar__button" id="btn-github" title="GitHub">
                    <span class="icon">&#128279;</span>
                    <span class="label">GitHub</span>
                </button>

                <button class="toolbar__button" id="btn-bookstack" title="BookStack (Ctrl+K)">
                    <span class="icon">&#128218;</span>
                    <span class="label">BookStack</span>
                </button>

                <button class="toolbar__button" id="btn-toggle-sidebar" title="Toggle Transform Panel">
                    <span class="icon">&#9776;</span>
                </button>

                <button class="toolbar__button" id="btn-theme" title="Toggle Theme">
                    <span class="icon">&#9788;</span>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="main-content">

            <!-- Transform Sidebar -->
            <aside class="sidebar" id="transform-sidebar">
                <div class="sidebar__header">
                    <h2 class="sidebar__title">Transformations</h2>
                </div>

                <div class="sidebar__content">

                    <!-- Newline Operations -->
                    <section class="sidebar__section">
                        <h3 class="sidebar__section-title">Text Formatting</h3>

                        <button class="sidebar__action" id="action-remove-newlines">
                            <span class="action__icon">&#10227;</span>
                            <span class="action__label">Remove Newlines</span>
                        </button>

                        <div class="sidebar__options" id="newline-options" style="display: none;">
                            <label class="option">
                                <input type="radio" name="newline-mode" value="smart" checked>
                                <span>Smart (preserve structure)</span>
                            </label>
                            <label class="option">
                                <input type="radio" name="newline-mode" value="paragraph">
                                <span>Paragraph only</span>
                            </label>
                            <label class="option">
                                <input type="radio" name="newline-mode" value="aggressive">
                                <span>Aggressive</span>
                            </label>
                        </div>

                        <button class="sidebar__action" id="action-find-replace">
                            <span class="action__icon">&#128269;</span>
                            <span class="action__label">Find & Replace</span>
                        </button>
                    </section>

                    <!-- Translation -->
                    <section class="sidebar__section">
                        <h3 class="sidebar__section-title">Translation</h3>

                        <div class="form-group">
                            <label for="translate-lang">Target Language</label>
                            <select id="translate-lang" class="form-select">
                                <option value="Spanish">Spanish</option>
                                <option value="French">French</option>
                                <option value="German">German</option>
                                <option value="Italian">Italian</option>
                                <option value="Portuguese">Portuguese</option>
                                <option value="Russian">Russian</option>
                                <option value="Chinese">Chinese</option>
                                <option value="Japanese">Japanese</option>
                                <option value="Korean">Korean</option>
                            </select>
                        </div>

                        <button class="sidebar__action" id="action-translate">
                            <span class="action__icon">&#127758;</span>
                            <span class="action__label">Translate</span>
                        </button>
                    </section>

                    <!-- LLM Operations -->
                    <section class="sidebar__section">
                        <h3 class="sidebar__section-title">LLM Transformations</h3>

                        <button class="sidebar__action" id="action-tone-formal">
                            <span class="action__icon">&#128188;</span>
                            <span class="action__label">Formal Tone</span>
                        </button>

                        <button class="sidebar__action" id="action-tone-casual">
                            <span class="action__icon">&#128172;</span>
                            <span class="action__label">Casual Tone</span>
                        </button>

                        <button class="sidebar__action" id="action-summarize">
                            <span class="action__icon">&#128220;</span>
                            <span class="action__label">Summarize</span>
                        </button>

                        <button class="sidebar__action" id="action-expand">
                            <span class="action__icon">&#128214;</span>
                            <span class="action__label">Expand</span>
                        </button>
                    </section>

                    <!-- Custom Prompt -->
                    <section class="sidebar__section">
                        <h3 class="sidebar__section-title">Custom LLM Prompt</h3>

                        <div class="form-group">
                            <label for="custom-prompt">Instructions</label>
                            <textarea
                                id="custom-prompt"
                                class="form-textarea"
                                rows="3"
                                placeholder="e.g., Make this more technical..."
                            ></textarea>
                        </div>

                        <div class="form-group">
                            <label for="llm-model">Model</label>
                            <select id="llm-model" class="form-select">
                                <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                                <option value="anthropic/claude-3-opus">Claude 3 Opus</option>
                                <option value="anthropic/claude-3-haiku">Claude 3 Haiku</option>
                                <option value="openai/gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="openai/gpt-4">GPT-4</option>
                            </select>
                        </div>

                        <button class="sidebar__action" id="action-custom-prompt">
                            <span class="action__icon">&#9998;</span>
                            <span class="action__label">Apply Prompt</span>
                        </button>
                    </section>

                </div>
            </aside>

            <!-- Editor and Preview Area -->
            <div class="editor-container">

                <!-- View Mode Toggle -->
                <div class="view-controls">
                    <div class="view-controls__tabs">
                        <button class="view-tab view-tab--active" data-view="split">
                            <span>Split View</span>
                        </button>
                        <button class="view-tab" data-view="edit">
                            <span>Edit Only</span>
                        </button>
                        <button class="view-tab" data-view="preview">
                            <span>Preview Only</span>
                        </button>
                    </div>

                    <div class="view-controls__status" id="editor-status">
                        <span id="status-chars">0 chars</span>
                        <span class="divider">•</span>
                        <span id="status-words">0 words</span>
                        <span class="divider">•</span>
                        <span id="status-lines">1 line</span>
                        <span class="divider">•</span>
                        <span id="status-tokens">0 tokens</span>
                    </div>
                </div>

                <!-- Split Pane Container -->
                <div class="split-pane" id="split-pane">

                    <!-- Editor Pane -->
                    <div class="pane pane--editor" id="editor-pane">
                        <div id="editor"></div>
                    </div>

                    <!-- Resize Handle -->
                    <div class="resize-handle" id="resize-handle"></div>

                    <!-- Preview Pane -->
                    <div class="pane pane--preview" id="preview-pane">
                        <div class="preview-content" id="preview"></div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Export Dialog -->
    <dialog class="dialog" id="export-dialog">
        <div class="dialog__header">
            <h2 class="dialog__title">Export Document</h2>
            <button class="dialog__close" id="close-export-dialog">×</button>
        </div>

        <div class="dialog__content">
            <div class="export-options">
                <button class="export-option" data-format="md">
                    <span class="export-option__icon">&#128221;</span>
                    <span class="export-option__label">Markdown (.md)</span>
                </button>

                <button class="export-option" data-format="html">
                    <span class="export-option__icon">&#127760;</span>
                    <span class="export-option__label">HTML (.html)</span>
                </button>

                <button class="export-option" data-format="pdf">
                    <span class="export-option__icon">&#128196;</span>
                    <span class="export-option__label">PDF (.pdf)</span>
                </button>

                <button class="export-option" data-format="docx">
                    <span class="export-option__icon">&#128196;</span>
                    <span class="export-option__label">Word (.docx)</span>
                </button>
            </div>
        </div>
    </dialog>

    <!-- Import Dialog -->
    <dialog class="dialog" id="import-dialog">
        <div class="dialog__header">
            <h2 class="dialog__title">Import Conversation</h2>
            <button class="dialog__close" id="close-import-dialog">×</button>
        </div>

        <div class="dialog__content">
            <p class="dialog__description">
                Import a ChatGPT conversation from a share link. The conversation will be loaded as a new document.
            </p>

            <div class="form-group">
                <label for="import-url-input" class="form-label">ChatGPT Share URL</label>
                <input
                    type="url"
                    id="import-url-input"
                    class="form-input"
                    placeholder="https://chatgpt.com/share/..."
                    required
                >
            </div>

            <div id="import-error-message" class="error-message" style="display: none;"></div>
            <div id="import-progress" class="progress-message" style="display: none;"></div>

            <div class="dialog__actions">
                <button id="import-execute-btn" class="button button--primary">
                    Import Conversation
                </button>
            </div>
        </div>
    </dialog>

    <!-- GitHub Dialog -->
    <dialog class="dialog" id="github-dialog">
        <div class="dialog__header">
            <h2 class="dialog__title">GitHub Integration</h2>
            <button class="dialog__close" id="close-github-dialog">×</button>
        </div>

        <div class="dialog__content" id="github-content">
            <!-- Content loaded dynamically -->
        </div>
    </dialog>

    <!-- BookStack Dialog -->
    <dialog class="dialog" id="bookstack-dialog">
        <div class="dialog__header">
            <h2 class="dialog__title">BookStack Integration</h2>
            <button class="dialog__close" id="close-bookstack-dialog">×</button>
        </div>

        <div class="dialog__content" id="bookstack-dialog-body">
            <!-- Content loaded dynamically -->
        </div>

        <div class="dialog__footer" id="bookstack-dialog-footer">
            <!-- Footer loaded dynamically -->
        </div>
    </dialog>

    <!-- BookStack Save Dialog -->
    <dialog class="dialog" id="bookstack-save-dialog">
        <div class="dialog__header">
            <h2 class="dialog__title" id="bookstack-save-title">Save to BookStack</h2>
            <button class="dialog__close" id="close-bookstack-save-dialog">×</button>
        </div>

        <div class="dialog__content">
            <form id="bookstack-save-form">
                <div class="form-group">
                    <label for="bookstack-save-name">Page Name</label>
                    <input type="text" id="bookstack-save-name" class="form-input" placeholder="Enter page name..." required>
                </div>

                <div class="form-group">
                    <label for="bookstack-save-shelf">Shelf</label>
                    <select id="bookstack-save-shelf" class="form-select">
                        <option value="">Loading shelves...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="bookstack-save-book">Book</label>
                    <select id="bookstack-save-book" class="form-select" required>
                        <option value="">Select a shelf first</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="bookstack-save-chapter">Chapter (Optional)</label>
                    <select id="bookstack-save-chapter" class="form-select">
                        <option value="">No chapter (top level)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="bookstack-save-tags">Tags (Optional)</label>
                    <input type="text" id="bookstack-save-tags" class="form-input" placeholder="tag1, tag2, tag3">
                    <small class="form-help">Comma-separated tags</small>
                </div>

                <div class="dialog__actions">
                    <button type="button" class="btn btn--secondary" id="bookstack-save-cancel">Cancel</button>
                    <button type="submit" class="btn btn--primary" id="bookstack-save-submit">Save</button>
                </div>
            </form>
        </div>
    </dialog>

    <!-- BookStack Conflict Dialog -->
    <dialog class="dialog" id="bookstack-conflict-dialog">
        <div class="dialog__header">
            <h2 class="dialog__title">⚠️ Conflict Detected</h2>
            <button class="dialog__close" id="close-bookstack-conflict-dialog">×</button>
        </div>

        <div class="dialog__content">
            <p class="conflict-message">
                This page has been modified on the server since you loaded it.
            </p>

            <div class="conflict-details">
                <div class="conflict-info">
                    <strong>Page:</strong> <span id="conflict-page-name"></span>
                </div>
                <div class="conflict-info">
                    <strong>Last Updated:</strong> <span id="conflict-updated-at"></span>
                </div>
            </div>

            <div class="conflict-options">
                <div class="conflict-option">
                    <h4>Your Changes</h4>
                    <p>Your local version will overwrite the server version.</p>
                </div>
                <div class="conflict-option">
                    <h4>Server Version</h4>
                    <p>Discard your changes and keep the server version.</p>
                </div>
            </div>

            <div class="dialog__actions">
                <button class="btn btn--secondary" id="conflict-cancel">Cancel</button>
                <button class="btn btn--warning" id="conflict-view-diff">View Differences</button>
                <button class="btn btn--primary" id="conflict-overwrite">Overwrite Server</button>
            </div>
        </div>
    </dialog>

    <!-- Save Destination Dialog (for new documents) -->
    <dialog class="dialog" id="save-destination-dialog">
        <div class="dialog__header">
            <h2 class="dialog__title">Save Document</h2>
            <button class="dialog__close" id="close-save-destination-dialog">×</button>
        </div>

        <div class="dialog__content">
            <p class="destination-message">Where would you like to save this document?</p>

            <div class="destination-options">
                <button class="destination-option" id="destination-local">
                    <span class="destination-icon">&#128190;</span>
                    <div class="destination-info">
                        <h4>Local File</h4>
                        <p>Save to your computer</p>
                    </div>
                </button>

                <button class="destination-option" id="destination-github">
                    <span class="destination-icon">&#128279;</span>
                    <div class="destination-info">
                        <h4>GitHub</h4>
                        <p>Save to a GitHub repository</p>
                    </div>
                </button>

                <button class="destination-option" id="destination-bookstack">
                    <span class="destination-icon">&#128218;</span>
                    <div class="destination-info">
                        <h4>BookStack</h4>
                        <p>Save to BookStack wiki</p>
                    </div>
                </button>
            </div>

            <div class="dialog__actions">
                <button class="btn btn--secondary" id="destination-cancel">Cancel</button>
            </div>
        </div>
    </dialog>

    <!-- Find & Replace Dialog -->
    <dialog class="dialog" id="find-replace-dialog">
        <div class="dialog__header">
            <h2 class="dialog__title">Find & Replace</h2>
            <button class="dialog__close" id="close-find-replace-dialog">×</button>
        </div>

        <div class="dialog__content">
            <!-- Tabs -->
            <div class="fr-tabs">
                <button class="fr-tab fr-tab--active" id="fr-tab-basic">Basic</button>
                <button class="fr-tab" id="fr-tab-ai">AI Assistant</button>
            </div>

            <!-- Basic Tab Content -->
            <div id="fr-basic-content">
                <div class="fr-form-group">
                    <label for="fr-preset">Pattern Type</label>
                    <select id="fr-preset">
                        <!-- Options populated dynamically -->
                    </select>
                    <div class="fr-example" id="fr-example"></div>
                </div>

                <div class="fr-form-group">
                    <label for="fr-find">Find</label>
                    <input type="text" id="fr-find" placeholder="Enter text to find...">
                </div>

                <div class="fr-form-group">
                    <label for="fr-replace">Replace with</label>
                    <input type="text" id="fr-replace" placeholder="Enter replacement text...">
                </div>

                <div class="fr-checkbox-group">
                    <label>
                        <input type="checkbox" id="fr-case-sensitive">
                        <span>Case sensitive</span>
                    </label>
                </div>

                <div class="fr-preview" style="display: none;">
                    <div class="fr-preview-stats" id="fr-preview-stats">No matches</div>
                    <div class="fr-preview-samples" id="fr-preview-samples"></div>
                </div>

                <div class="fr-buttons">
                    <button class="fr-btn fr-btn--secondary" id="fr-preview-btn">Preview</button>
                    <button class="fr-btn fr-btn--primary" id="fr-replace-all-btn">Replace All</button>
                </div>
            </div>

            <!-- AI Tab Content -->
            <div id="fr-ai-content" style="display: none;">
                <div class="fr-form-group">
                    <label for="fr-ai-description">Describe what you want to find</label>
                    <textarea id="fr-ai-description" rows="3" placeholder="e.g., all email addresses, markdown headers, phone numbers..."></textarea>
                </div>

                <div class="fr-buttons">
                    <button class="fr-btn fr-btn--primary" id="fr-ai-generate-btn">✨ Generate Pattern</button>
                </div>

                <div class="fr-ai-explanation" id="fr-ai-explanation" style="display: none;">
                    Pattern explanation will appear here
                </div>

                <div class="fr-ai-examples" id="fr-ai-examples" style="display: none;">
                    <!-- Examples populated dynamically -->
                </div>

                <div class="fr-form-group" style="display: none;" id="fr-ai-pattern-group">
                    <label for="fr-ai-pattern">Generated Pattern</label>
                    <input type="text" id="fr-ai-pattern" readonly>
                </div>

                <div class="fr-form-group" style="display: none;" id="fr-ai-flags-group">
                    <label for="fr-ai-flags">Flags</label>
                    <input type="text" id="fr-ai-flags" readonly>
                </div>

                <div class="fr-form-group">
                    <label for="fr-ai-replacement">Replace with</label>
                    <input type="text" id="fr-ai-replacement" placeholder="Enter replacement text...">
                </div>

                <div class="fr-preview" style="display: none;" id="fr-ai-preview">
                    <div class="fr-preview-stats" id="fr-ai-preview-stats">No matches</div>
                    <div class="fr-preview-samples" id="fr-ai-preview-samples"></div>
                </div>

                <div class="fr-buttons">
                    <button class="fr-btn fr-btn--secondary" id="fr-ai-preview-btn" style="display: none;">Preview</button>
                    <button class="fr-btn fr-btn--primary" id="fr-ai-apply-btn">Apply</button>
                </div>
            </div>
        </div>
    </dialog>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <p class="loading-text" id="loading-text">Processing...</p>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toast-container"></div>

</body>
</html>
